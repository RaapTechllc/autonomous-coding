<project_specification>
  <project_name>SMW Commission Agent - Commission Dashboard</project_name>

  <overview>
    Build a commission tracking dashboard for SMW that turns CRM revenue data into clear, auditable commission payouts.
    The app should sync deals from Salesforce (and/or CSV import), calculate commissions from plan rules, generate period
    statements, and support review + approvals before payout. It should also include an “AI Commission Agent” that can
    explain any payout line item using the underlying data and rules (no guessing).

    MVP focuses on: Salesforce/CSV ingest, a rules-based calculator, statements, and a clean rep-facing dashboard.
    Post-MVP adds: richer rule engine, workflows, disputes, forecasting, and payroll integrations.
  </overview>

  <technology_stack>
    <frontend>
      <framework>React 18+ with Vite 5+</framework>
      <styling>Tailwind CSS (via CDN)</styling>
      <state_management>React hooks and context</state_management>
      <routing>React Router</routing>
      <charts>Recharts</charts>
      <tables>TanStack Table</tables>
      <port>Only launch on port 5173</port>
    </frontend>

    <backend>
      <runtime>Node.js with Express</runtime>
      <database>SQLite with better-sqlite3 (MVP), Postgres-ready schema (post-MVP)</database>
      <auth>Session or JWT auth with RBAC</auth>
      <jobs>node-cron (MVP), queue-backed jobs (post-MVP)</jobs>
      <integrations>Salesforce REST sync + CSV import</integrations>
      <streaming>SSE for sync progress + long-running calc progress</streaming>
    </backend>

    <communication>
      <api>RESTful endpoints</api>
      <streaming>SSE</streaming>
    </communication>

    <ai_commission_agent>
      <mode>Optional in MVP; full post-MVP</mode>
      <approach>Tool-based responses grounded in stored commission data and plan rules</approach>
      <guardrails>No external facts. No payout changes without explicit user action.</guardrails>
    </ai_commission_agent>
  </technology_stack>

  <prerequisites>
    <environment_setup>
      - Follow the Harness repo conventions. Do not change the harness behavior.
      - Frontend uses the existing Vite + pnpm setup in the repo.
      - Backend code lives in /server.
      - Use .env for secrets:
        - SALESFORCE_CLIENT_ID, SALESFORCE_CLIENT_SECRET (if used)
        - SALESFORCE_LOGIN_URL (prod/sandbox)
        - SALESFORCE_REDIRECT_URI
        - APP_SECRET (sessions/JWT signing)
      - Start services using the repo’s standard scripts.
    </environment_setup>
  </prerequisites>

  <core_features>
    <mvp_scope>
      <data_ingest>
        - Connect to Salesforce and pull Opportunities + key fields (amount, stage, close date, owner, account, products if available)
        - Manual CSV import as fallback (same canonical schema)
        - Field mapping UI (simple mapping wizard)
        - Sync run log with status, counts, and errors
      </data_ingest>

      <commission_plans>
        - Create a plan with versions (effective_start, effective_end)
        - Basic rule types:
          - Flat percent of commissionable amount
          - Tiered percent by amount thresholds
          - Split support (percent splits across reps)
        - Plan assignment by rep (user)
      </commission_plans>

      <commission_calculation>
        - Deterministic calculator that produces:
          - Per-deal commission line items
          - Per-period statement totals
        - Recalculate on demand (idempotent; snapshots saved)
        - Audit trail for every calculation run
      </commission_calculation>

      <statements>
        - Generate statements for a pay period (monthly default)
        - Statement line items per opportunity (and adjustments)
        - Export CSV (MVP) and print-friendly view
      </statements>

      <rep_dashboard>
        - YTD commissions, current period estimate, last payout
        - Deal list with “commission status” (pending, eligible, calculated)
        - Filters by period, stage, rep
      </rep_dashboard>

      <admin_basics>
        - User management (rep/admin roles)
        - Global settings: currency, pay period cadence, rounding rules
      </admin_basics>
    </mvp_scope>

    <post_mvp_scope>
      <workflows>
        - Rep review + acknowledgement
        - Manager approval
        - Finance finalize
        - Payout marking (paid date, method, reference)
      </workflows>

      <disputes_adjustments>
        - Dispute a line item with comments and attachments
        - Adjustment types: spiff/bonus, clawback, true-up, manual override
        - Approval required for overrides
      </disputes_adjustments>

      <advanced_plans>
        - More rule dimensions:
          - Product/category rates
          - Region/segment multipliers
          - Stage gating (pay only at Closed Won)
          - Quota + accelerators
          - Draws and recoverable draws
          - Caps and floors
        - Rule testing sandbox (simulate a deal)
      </advanced_plans>

      <forecasting_analytics>
        - Pipeline-to-commission forecast
        - Quota attainment tracking
        - Leaderboards (optional)
        - “What-if” plan comparison
      </forecasting_analytics>

      <integrations>
        - Scheduled sync (nightly) + on-demand sync
        - Payroll export formats (configurable)
        - Webhook support (if available)
      </integrations>

      <ai_commission_agent>
        - Ask questions like:
          - “Why is this deal paying $X?”
          - “What plan rules were applied?”
          - “What deals are missing data?”
          - “What do I need to close to hit $Y this month?”
        - Agent produces answers with:
          - linked opportunities
          - linked plan version + rules
          - calculation snapshot references
        - Agent can draft dispute tickets and adjustment requests (but cannot apply them without user confirmation)
      </ai_commission_agent>

      <security_compliance>
        - RBAC (rep/manager/finance/admin)
        - Encrypted token storage for integrations
        - Full audit log export
      </security_compliance>
    </post_mvp_scope>
  </core_features>

  <database_schema>
    <tables>
      <users>
        - id, email, name
        - role (rep/manager/finance/admin)
        - is_active
        - created_at, updated_at
      </users>

      <settings>
        - id
        - currency, rounding_mode, pay_period_type
        - created_at, updated_at
      </settings>

      <integrations_salesforce>
        - id
        - auth_type (oauth/jwt/manual)
        - instance_url
        - access_token_encrypted, refresh_token_encrypted (if applicable)
        - last_sync_at
        - created_at, updated_at
      </integrations_salesforce>

      <sync_runs>
        - id, source (salesforce/csv)
        - started_at, finished_at, status
        - records_in, records_upserted, records_failed
        - error_summary
      </sync_runs>

      <opportunities>
        - id
        - external_id (salesforce_id or csv_key)
        - name, account_name
        - owner_user_id
        - stage, close_date
        - amount, commissionable_amount
        - currency
        - raw_payload (JSON)
        - created_at, updated_at
      </opportunities>

      <opportunity_splits>
        - id, opportunity_id
        - user_id
        - split_percent
      </opportunity_splits>

      <commission_plans>
        - id, name, description
        - created_at, updated_at
      </commission_plans>

      <commission_plan_versions>
        - id, plan_id
        - version_name
        - effective_start, effective_end
        - status (draft/active/retired)
        - created_at, updated_at
      </commission_plan_versions>

      <commission_rules>
        - id, plan_version_id
        - rule_type (flat_percent/tiered_percent)
        - config (JSON)
        - priority
      </commission_rules>

      <plan_assignments>
        - id
        - user_id
        - plan_version_id
        - effective_start, effective_end
      </plan_assignments>

      <calculation_runs>
        - id
        - period_start, period_end
        - triggered_by_user_id
        - status
        - created_at, finished_at
      </calculation_runs>

      <commission_line_items>
        - id
        - calculation_run_id
        - opportunity_id
        - user_id
        - plan_version_id
        - rule_applied_summary
        - commission_amount
        - details (JSON snapshot of inputs + applied tiers)
        - created_at
      </commission_line_items>

      <statements>
        - id
        - user_id
        - period_start, period_end
        - total_commission
        - status (draft/final)
        - created_at, updated_at
      </statements>

      <statement_items>
        - id
        - statement_id
        - line_item_id (nullable)
        - kind (opportunity/adjustment)
        - description
        - amount
      </statement_items>

      <adjustments>
        - id
        - user_id
        - period_start, period_end
        - type (bonus/clawback/trueup/override)
        - amount
        - reason
        - status (pending/approved/rejected/applied)
        - created_at, updated_at
      </adjustments>

      <audit_events>
        - id
        - actor_user_id
        - entity_type, entity_id
        - action
        - before (JSON), after (JSON)
        - created_at
      </audit_events>

      <disputes>
        - id
        - user_id
        - statement_item_id
        - status (open/triaged/resolved/denied)
        - reason
        - created_at, updated_at
      </disputes>
    </tables>
  </database_schema>

  <api_endpoints_summary>
    <auth>
      - POST /api/auth/login
      - POST /api/auth/logout
      - GET /api/auth/me
    </auth>

    <users>
      - GET /api/users
      - POST /api/users
      - PUT /api/users/:id
      - PUT /api/users/:id/disable
    </users>

    <settings>
      - GET /api/settings
      - PUT /api/settings
    </settings>

    <integrations>
      - POST /api/integrations/salesforce/connect
      - POST /api/integrations/salesforce/disconnect
      - GET /api/integrations/salesforce/status
    </integrations>

    <sync>
      - POST /api/sync/salesforce/run
      - POST /api/sync/csv/import
      - GET /api/sync/runs
      - GET /api/sync/runs/:id
      - GET /api/sync/stream (SSE)
    </sync>

    <opportunities>
      - GET /api/opportunities
      - GET /api/opportunities/:id
      - PUT /api/opportunities/:id (admin override fields like commissionable_amount)
    </opportunities>

    <plans>
      - GET /api/plans
      - POST /api/plans
      - GET /api/plans/:id
      - POST /api/plans/:id/versions
      - PUT /api/plan-versions/:id
      - POST /api/plan-versions/:id/activate
      - POST /api/plan-versions/:id/test
    </plans>

    <calculations>
      - POST /api/calculations/run
      - GET /api/calculations/runs
      - GET /api/calculations/runs/:id
      - GET /api/calculations/stream (SSE)
    </calculations>

    <statements>
      - GET /api/statements?period=YYYY-MM
      - POST /api/statements/generate
      - GET /api/statements/:id
      - GET /api/statements/:id/export/csv
      - PUT /api/statements/:id/finalize
    </statements>

    <adjustments>
      - GET /api/adjustments
      - POST /api/adjustments
      - PUT /api/adjustments/:id/approve
      - PUT /api/adjustments/:id/reject
    </adjustments>

    <disputes>
      - GET /api/disputes
      - POST /api/disputes
      - PUT /api/disputes/:id/status
      - POST /api/disputes/:id/comment
    </disputes>

    <audit>
      - GET /api/audit?entity_type=&entity_id=
    </audit>

    <ai_agent>
      - POST /api/agent/ask
      - POST /api/agent/draft-dispute
      - POST /api/agent/draft-adjustment
    </ai_agent>
  </api_endpoints_summary>

  <ui_layout>
    <main_structure>
      - Two-column layout (MVP): left nav + main content
      - Optional right drawer (post-MVP): inspector / AI agent / details
      - Responsive: mobile collapses nav into hamburger
    </main_structure>

    <sidebar_left>
      - Dashboard
      - Deals
      - Statements
      - Plans (admin)
      - Sync (admin)
      - Users (admin)
      - Settings
    </sidebar_left>

    <main_views>
      <dashboard>
        - KPI cards (YTD, current period, last payout)
        - Trends chart (by month)
        - “Needs attention” list (missing data, sync errors)
      </dashboard>

      <deals>
        - Table with filters and row detail drawer
        - Columns: name, stage, amount, commissionable_amount, owner, status, estimated_commission
      </deals>

      <statements>
        - Period picker
        - Statement summary + line items
        - Export actions
      </statements>

      <plans>
        - Plan list
        - Version editor (rules builder)
        - Test sandbox
      </plans>

      <sync>
        - Connect status
        - Run sync button
        - Sync run log + progress
      </sync>
    </main_views>
  </ui_layout>

  <design_system>
    <color_palette>
      - Primary: Deep blue or teal accent (trust/finance feel)
      - Background: Light and dark mode
      - Status colors: pending/eligible/calculated/finalized
    </color_palette>

    <typography>
      - Inter/system font
      - Clear hierarchy for money numbers (large, bold)
      - Monospace for IDs and rule debugging
    </typography>

    <components>
      - KPI cards
      - Data tables with sticky header
      - Period picker
      - Drawer panel for details
      - Timeline/audit list
      - Empty states with next-step CTA
    </components>

    <animations>
      - Subtle transitions
      - Progress indicators for sync and calculations
    </animations>
  </design_system>

  <key_interactions>
    <sync_flow>
      1. Admin connects Salesforce (or uploads CSV)
      2. User runs sync
      3. SSE shows progress and errors
      4. Opportunities list updates
    </sync_flow>

    <calc_flow>
      1. Admin selects period and runs calculation
      2. Calculator applies plan versions and splits
      3. Line items are saved as immutable snapshots
      4. Statements can be generated from snapshots
    </calc_flow>

    <statement_flow>
      1. Rep opens the period statement
      2. Rep drills into a line item to see rule explanation
      3. Rep exports CSV or prints
      4. Post-MVP: rep disputes a line item
    </statement_flow>

    <agent_flow>
      1. User asks “Why is this $X?”
      2. Agent fetches the line item snapshot + plan version + rules
      3. Agent returns a grounded explanation and links to records
      4. Agent can draft a dispute or adjustment request
    </agent_flow>
  </key_interactions>

  <implementation_steps>
    <step number="1">
      <title>Foundation and Data Model</title>
      <tasks>
        - Set up /server Express app with SQLite and migrations
        - Implement RBAC auth (rep/admin minimum)
        - Create core tables: users, opportunities, plans, calculations, statements, audit_events
        - Add seed data and fixtures for local dev
      </tasks>
    </step>

    <step number="2">
      <title>Frontend Shell and Navigation</title>
      <tasks>
        - Build app layout with sidebar and routing
        - Implement Dashboard, Deals, Statements pages (empty state first)
        - Add reusable table, KPI cards, and period picker components
      </tasks>
    </step>

    <step number="3">
      <title>Ingest: CSV First, Salesforce Next</title>
      <tasks>
        - Build CSV import endpoint + mapping UI
        - Normalize into opportunities table
        - Add sync_runs log and error reporting
        - Add Salesforce connect + pull as post-MVP toggle if needed
      </tasks>
    </step>

    <step number="4">
      <title>Commission Plan Builder (MVP Rules)</title>
      <tasks>
        - Plan + version CRUD
        - Flat percent + tiered percent rules in config JSON
        - Assign active plan version to reps
        - Plan test endpoint: input deal => expected commission
      </tasks>
    </step>

    <step number="5">
      <title>Commission Calculator and Snapshots</title>
      <tasks>
        - Build deterministic calculation engine
        - Support splits and rounding rules
        - Persist commission_line_items with details snapshot
        - Expose calculation runs and logs
      </tasks>
    </step>

    <step number="6">
      <title>Statements and Exports</title>
      <tasks>
        - Generate statements from snapshots per period
        - Build statement UI and CSV export
        - Add basic print-friendly layout
      </tasks>
    </step>

    <step number="7">
      <title>Post-MVP Workflows, Disputes, Adjustments</title>
      <tasks>
        - Add approvals statuses and roles (manager/finance)
        - Dispute tickets with comments
        - Adjustments module and approval gates
      </tasks>
    </step>

    <step number="8">
      <title>AI Commission Agent (Grounded)</title>
      <tasks>
        - Tool endpoints for fetching line items, plan rules, and audit history
        - Agent chat UI in right drawer
        - Draft dispute and draft adjustment flows
      </tasks>
    </step>

    <step number="9">
      <title>Hardening and Scale</title>
      <tasks>
        - Automated tests for calculator (golden fixtures)
        - Data integrity checks and idempotent sync/calc
        - Role-based UI guards
        - Postgres migration path and background job queue
      </tasks>
    </step>
  </implementation_steps>

  <success_criteria>
    <functionality>
      - Import/sync creates clean opportunity records
      - Calculator produces repeatable results from the same inputs
      - Statements match saved calculation snapshots
      - Exports are correct and usable for payout processing
      - Audit trail shows who changed what and when
    </functionality>

    <user_experience>
      - Reps can understand “what I’m getting paid and why” in under 60 seconds
      - Admin can update plans without breaking past statements
      - Sync and calc progress is transparent and fast
    </user_experience>

    <technical_quality>
      - Calculator is unit-tested with fixtures
      - Schema supports plan versioning and immutability of past payouts
      - Secure secret handling and token encryption (when used)
      - Clear error handling and logs for ingest + calculations
    </technical_quality>
  </success_criteria>
</project_specification>
